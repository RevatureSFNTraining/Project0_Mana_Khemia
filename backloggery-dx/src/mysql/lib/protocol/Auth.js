var Buffer=require("safe-buffer").Buffer,Crypto=require("crypto"),Auth=exports;function auth(t,r,e){if(e=e||{},"mysql_native_password"===t)return Auth.token(e.password,r.slice(0,20))}function sha1(t){var r=Crypto.createHash("sha1");return r.update(t,"binary"),r.digest("binary")}function xor(t,r){t=Buffer.from(t,"binary"),r=Buffer.from(r,"binary");for(var e=Buffer.allocUnsafe(t.length),n=0;n<t.length;n++)e[n]=t[n]^r[n];return e}Auth.auth=auth,Auth.sha1=sha1,Auth.xor=xor,Auth.token=function(t,r){if(!t)return Buffer.alloc(0);var e=sha1(Buffer.from(t,"utf8").toString("binary")),n=sha1(e);return xor(sha1(r.toString("binary")+n),e)},Auth.hashPassword=function(t){var r=[20528,22325],e=7,n=[4660,22129],a=Buffer.alloc(8);"string"==typeof t&&(t=Buffer.from(t));for(var u=0;u<t.length;u++){var i=t[u];32!==i&&9!==i&&(r=this.xor32(r,this.add32(this.mul32(this.add32(this.and32(r,[0,63]),[0,e]),[0,i]),this.shl32(r,8))),n=this.add32(n,this.xor32(this.shl32(n,8),r)),e+=i)}return this.int31Write(a,r,0),this.int31Write(a,n,4),a},Auth.randomInit=function(t,r){return{max_value:1073741823,max_value_dbl:1073741823,seed1:t%1073741823,seed2:r%1073741823}},Auth.myRnd=function(t){return t.seed1=(3*t.seed1+t.seed2)%t.max_value,t.seed2=(t.seed1+t.seed2+33)%t.max_value,t.seed1/t.max_value_dbl},Auth.scramble323=function(t,r){if(!r)return Buffer.alloc(0);for(var e=Buffer.allocUnsafe(8),n=this.hashPassword(r),a=this.hashPassword(t.slice(0,8)),u=this.int32Read(n,0)^this.int32Read(a,0),i=this.int32Read(n,4)^this.int32Read(a,4),s=this.randomInit(u,i),h=0;h<8;h++)e[h]=Math.floor(31*this.myRnd(s))+64;var f=Math.floor(31*this.myRnd(s));for(h=0;h<8;h++)e[h]^=f;return e},Auth.xor32=function(t,r){return[t[0]^r[0],t[1]^r[1]]},Auth.add32=function(t,r){var e=t[1]+r[1];return[65535&t[0]+r[0]+((4294901760&e)>>16),65535&e]},Auth.mul32=function(t,r){var e=t[1]*r[1];return[65535&(t[1]*r[1]>>16&65535)+(t[0]*r[1]&65535)+(t[1]*r[0]&65535),65535&e]},Auth.and32=function(t,r){return[t[0]&r[0],t[1]&r[1]]},Auth.shl32=function(t,r){var e=t[1]<<r;return[65535&(t[0]<<r|(4294901760&e)>>16),65535&e]},Auth.int31Write=function(t,r,e){t[e]=r[0]>>8&127,t[e+1]=255&r[0],t[e+2]=r[1]>>8&255,t[e+3]=255&r[1]},Auth.int32Read=function(t,r){return(t[r]<<24)+(t[r+1]<<16)+(t[r+2]<<8)+t[r+3]};