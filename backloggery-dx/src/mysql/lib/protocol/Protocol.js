var Parser=require("./Parser"),Sequences=require("./sequences"),Packets=require("./packets"),Stream=require("stream").Stream,Util=require("util"),PacketWriter=require("./PacketWriter");function Protocol(e){Stream.call(this),e=e||{},this.readable=!0,this.writable=!0,this._config=e.config||{},this._connection=e.connection,this._callback=null,this._fatalError=null,this._quitSequence=null,this._handshake=!1,this._handshaked=!1,this._ended=!1,this._destroyed=!1,this._queue=[],this._handshakeInitializationPacket=null,this._parser=new Parser({onError:this.handleParserError.bind(this),onPacket:this._parsePacket.bind(this),config:this._config})}module.exports=Protocol,Util.inherits(Protocol,Stream),Protocol.prototype.write=function(e){return this._parser.write(e),!0},Protocol.prototype.handshake=function(e,t){"function"==typeof e&&(t=e,e={}),(e=e||{}).config=this._config;var r=this._enqueue(new Sequences.Handshake(e,t));return this._handshake=!0,r},Protocol.prototype.query=function(e,t){return this._enqueue(new Sequences.Query(e,t))},Protocol.prototype.changeUser=function(e,t){return this._enqueue(new Sequences.ChangeUser(e,t))},Protocol.prototype.ping=function(e,t){return"function"==typeof e&&(t=e,e={}),this._enqueue(new Sequences.Ping(e,t))},Protocol.prototype.stats=function(e,t){return"function"==typeof e&&(t=e,e={}),this._enqueue(new Sequences.Statistics(e,t))},Protocol.prototype.quit=function(e,t){"function"==typeof e&&(t=e,e={});var r=this,o=this._enqueue(new Sequences.Quit(e,t));return o.on("end",(function(){r.end()})),this._quitSequence=o},Protocol.prototype.end=function(){if(!this._ended){if(this._ended=!0,this._quitSequence&&(this._quitSequence._ended||this._queue[0]===this._quitSequence))return this._quitSequence.end(),void this.emit("end");var e=new Error("Connection lost: The server closed the connection.");e.fatal=!0,e.code="PROTOCOL_CONNECTION_LOST",this._delegateError(e)}},Protocol.prototype.pause=function(){this._parser.pause();var e=this._queue[0];e&&e.emit&&e.emit("pause")},Protocol.prototype.resume=function(){this._parser.resume();var e=this._queue[0];e&&e.emit&&e.emit("resume")},Protocol.prototype._enqueue=function(e){if(!this._validateEnqueue(e))return e;this._config.trace&&(e._callSite=e._callSite||new Error),this._queue.push(e),this.emit("enqueue",e);var t=this;return e.on("error",(function(r){t._delegateError(r,e)})).on("packet",(function(r){e._timer.active(),t._emitPacket(r)})).on("timeout",(function(){var r=new Error(e.constructor.name+" inactivity timeout");r.code="PROTOCOL_SEQUENCE_TIMEOUT",r.fatal=!0,r.timeout=e._timeout,t._delegateError(r,e)})),e.constructor===Sequences.Handshake&&(e.on("start-tls",(function(){e._timer.active(),t._connection._startTLS((function(t){if(t)return t.code="HANDSHAKE_SSL_ERROR",t.fatal=!0,void e.end(t);e._timer.active(),e._tlsUpgradeCompleteHandler()}))})),e.on("end",(function(){t._handshaked=!0,t._fatalError||t.emit("handshake",t._handshakeInitializationPacket)}))),e.on("end",(function(){t._dequeue(e)})),1===this._queue.length&&(this._parser.resetPacketNumber(),this._startSequence(e)),e},Protocol.prototype._validateEnqueue=function(e){var t,r="Cannot enqueue "+e.constructor.name;if(this._fatalError)(t=new Error(r+" after fatal error.")).code="PROTOCOL_ENQUEUE_AFTER_FATAL_ERROR";else if(this._quitSequence)(t=new Error(r+" after invoking quit.")).code="PROTOCOL_ENQUEUE_AFTER_QUIT";else if(this._destroyed)(t=new Error(r+" after being destroyed.")).code="PROTOCOL_ENQUEUE_AFTER_DESTROY";else{if(!this._handshake&&!this._handshaked||e.constructor!==Sequences.Handshake)return!0;(t=new Error(r+" after already enqueuing a Handshake.")).code="PROTOCOL_ENQUEUE_HANDSHAKE_TWICE"}var o=this;return t.fatal=!1,e.on("error",(function(t){o._delegateError(t,e)})),process.nextTick((function(){e.end(t)})),!1},Protocol.prototype._parsePacket=function(){var e=this._queue[0];if(!e)return(t=new Error("Received packet with no active sequence.")).code="PROTOCOL_STRAY_PACKET",t.fatal=!0,void this._delegateError(t);var t,r=this._determinePacket(e),o=new r({protocol41:this._config.protocol41}),n=r.name;return r===Packets.RowDataPacket?(e.RowDataPacket(o,this._parser,this._connection),void(this._config.debug&&this._debugPacket(!0,o))):(this._config.debug?this._parsePacketDebug(o):o.parse(this._parser),r===Packets.HandshakeInitializationPacket&&(this._handshakeInitializationPacket=o,this.emit("initialize",o)),e._timer.active(),e[n]?void e[n](o):((t=new Error("Received packet in the wrong sequence.")).code="PROTOCOL_INCORRECT_PACKET_SEQUENCE",t.fatal=!0,void this._delegateError(t)))},Protocol.prototype._parsePacketDebug=function(e){try{e.parse(this._parser)}finally{this._debugPacket(!0,e)}},Protocol.prototype._emitPacket=function(e){var t=new PacketWriter;e.write(t),this.emit("data",t.toBuffer(this._parser)),this._config.debug&&this._debugPacket(!1,e)},Protocol.prototype._determinePacket=function(e){var t=this._parser.peak();if(e.determinePacket){var r=e.determinePacket(t,this._parser);if(r)return r}switch(t){case 0:return Packets.OkPacket;case 254:return Packets.EofPacket;case 255:return Packets.ErrorPacket}throw new Error("Could not determine packet, firstByte = "+t)},Protocol.prototype._dequeue=function(e){e._timer.stop(),this._fatalError||(this._queue.shift(),(e=this._queue[0])?(this._parser.resetPacketNumber(),this._startSequence(e)):this.emit("drain"))},Protocol.prototype._startSequence=function(e){e._timeout>0&&isFinite(e._timeout)&&e._timer.start(e._timeout),e.constructor===Sequences.ChangeUser?e.start(this._handshakeInitializationPacket):e.start()},Protocol.prototype.handleNetworkError=function(e){e.fatal=!0;var t=this._queue[0];t?t.end(e):this._delegateError(e)},Protocol.prototype.handleParserError=function(e){var t=this._queue[0];t?t.end(e):this._delegateError(e)},Protocol.prototype._delegateError=function(e,t){if(!this._fatalError){if(e.fatal&&(this._fatalError=e),this._shouldErrorBubbleUp(e,t))this.emit("unhandledError",e);else if(e.fatal){var r=this._queue;process.nextTick((function(){r.forEach((function(t){t.end(e)})),r.length=0}))}e.fatal&&this.emit("end",e)}},Protocol.prototype._shouldErrorBubbleUp=function(e,t){if(t){if(t.hasErrorHandler())return!1;if(!e.fatal)return!0}return e.fatal&&!this._hasPendingErrorHandlers()},Protocol.prototype._hasPendingErrorHandlers=function(){return this._queue.some((function(e){return e.hasErrorHandler()}))},Protocol.prototype.destroy=function(){this._destroyed=!0,this._parser.pause(),"disconnected"!==this._connection.state&&(this._ended||this.end())},Protocol.prototype._debugPacket=function(e,t){var r=this._connection,o=e?"<--":"--\x3e",n=t.constructor.name,i=r&&null!==r.threadId?" ("+r.threadId+")":"";if(!Array.isArray(this._config.debug)||-1!==this._config.debug.indexOf(n)){var a=Util.inspect(t).replace(/^[^{]+/,"");console.log("%s%s %s %s\n",o,i,n,a)}};