var PacketHeader=require("./PacketHeader"),BigNumber=require("bignumber.js"),Buffer=require("safe-buffer").Buffer,BufferList=require("./BufferList"),MAX_PACKET_LENGTH=Math.pow(2,24)-1,MUL_32BIT=Math.pow(2,32),PACKET_HEADER_LENGTH=4;function Parser(e){e=e||{},this._supportBigNumbers=e.config&&e.config.supportBigNumbers,this._buffer=Buffer.alloc(0),this._nextBuffers=new BufferList,this._longPacketBuffers=new BufferList,this._offset=0,this._packetEnd=null,this._packetHeader=null,this._packetOffset=null,this._onError=e.onError||function(e){throw e},this._onPacket=e.onPacket||function(){},this._nextPacketNumber=0,this._encoding="utf-8",this._paused=!1}module.exports=Parser,Parser.prototype.write=function(e){for(this._nextBuffers.push(e);!this._paused;){var t=this._tryReadPacketHeader();if(!t)break;if(!this._combineNextBuffers(t.length))break;this._parsePacket(t)}},Parser.prototype.append=function(e){if(e&&0!==e.length){for(var t=this._buffer.length,r=null===this._packetOffset?this._offset:this._packetOffset,s=t-r,f=null,i=e instanceof Array||Array.isArray(e)?e:[e],n=0,a=0,o=0;o<i.length;o++)n+=i[o].length;if(0!==s)for(f=Buffer.allocUnsafe(s+n),a=0,a+=this._buffer.copy(f,0,r,t),o=0;o<i.length;o++)a+=i[o].copy(f,a);else if(i.length>1)for(f=Buffer.allocUnsafe(n),a=0,o=0;o<i.length;o++)a+=i[o].copy(f,a);else f=i[0];this._buffer=f,this._offset=this._offset-r,this._packetEnd=null!==this._packetEnd?this._packetEnd-r:null,this._packetOffset=null!==this._packetOffset?this._packetOffset-r:null}},Parser.prototype.pause=function(){this._paused=!0},Parser.prototype.resume=function(){this._paused=!1,process.nextTick(this.write.bind(this))},Parser.prototype.peak=function(e){return this._buffer[this._offset+(e>>>0)]},Parser.prototype.parseUnsignedNumber=function(e){if(1===e)return this._buffer[this._offset++];var t=this._buffer,r=this._offset+e-1,s=0;if(e>4){var f=new Error("parseUnsignedNumber: Supports only up to 4 bytes");throw f.offset=this._offset-this._packetOffset-1,f.code="PARSER_UNSIGNED_TOO_LONG",f}for(;r>=this._offset;)s=(s<<8|t[r])>>>0,r--;return this._offset+=e,s},Parser.prototype.parseLengthCodedString=function(){var e=this.parseLengthCodedNumber();return null===e?null:this.parseString(e)},Parser.prototype.parseLengthCodedBuffer=function(){var e=this.parseLengthCodedNumber();return null===e?null:this.parseBuffer(e)},Parser.prototype.parseLengthCodedNumber=function(){if(this._offset>=this._buffer.length)throw(f=new Error("Parser: read past end")).offset=this._offset-this._packetOffset,f.code="PARSER_READ_PAST_END",f;var e=this._buffer[this._offset++];if(e<=250)return e;switch(e){case 251:return null;case 252:return this.parseUnsignedNumber(2);case 253:return this.parseUnsignedNumber(3);case 254:break;default:throw(f=new Error("Unexpected first byte"+(e?": 0x"+e.toString(16):""))).offset=this._offset-this._packetOffset-1,f.code="PARSER_BAD_LENGTH_BYTE",f}var t,r=this.parseUnsignedNumber(4),s=this.parseUnsignedNumber(4);if(s>>>21){if(t=BigNumber(MUL_32BIT).times(s).plus(r).toString(),this._supportBigNumbers)return t;var f;throw(f=new Error('parseLengthCodedNumber: JS precision range exceeded, number is >= 53 bit: "'+t+'"')).offset=this._offset-this._packetOffset-8,f.code="PARSER_JS_PRECISION_RANGE_EXCEEDED",f}return r+MUL_32BIT*s},Parser.prototype.parseFiller=function(e){return this.parseBuffer(e)},Parser.prototype.parseNullTerminatedBuffer=function(){var e=this._nullByteOffset(),t=this._buffer.slice(this._offset,e);return this._offset=e+1,t},Parser.prototype.parseNullTerminatedString=function(){var e=this._nullByteOffset(),t=this._buffer.toString(this._encoding,this._offset,e);return this._offset=e+1,t},Parser.prototype._nullByteOffset=function(){for(var e=this._offset;0!==this._buffer[e];)if(++e>=this._buffer.length){var t=new Error("Offset of null terminated string not found.");throw t.offset=this._offset-this._packetOffset,t.code="PARSER_MISSING_NULL_BYTE",t}return e},Parser.prototype.parsePacketTerminatedBuffer=function(){var e=this._packetEnd-this._offset;return this.parseBuffer(e)},Parser.prototype.parsePacketTerminatedString=function(){var e=this._packetEnd-this._offset;return this.parseString(e)},Parser.prototype.parseBuffer=function(e){var t=Buffer.alloc(e);return this._buffer.copy(t,0,this._offset,this._offset+e),this._offset+=e,t},Parser.prototype.parseString=function(e){var t=this._offset,r=t+e,s=this._buffer.toString(this._encoding,t,r);return this._offset=r,s},Parser.prototype.parseGeometryValue=function(){var e=this.parseLengthCodedBuffer(),t=4;return null!==e&&e.length?function r(){var s=null,f=e.readUInt8(t);t+=1;var i=f?e.readUInt32LE(t):e.readUInt32BE(t);switch(t+=4,i){case 1:var n=f?e.readDoubleLE(t):e.readDoubleBE(t);t+=8;var a=f?e.readDoubleLE(t):e.readDoubleBE(t);t+=8,s={x:n,y:a};break;case 2:var o=f?e.readUInt32LE(t):e.readUInt32BE(t);t+=4,s=[];for(var u=o;u>0;u--)n=f?e.readDoubleLE(t):e.readDoubleBE(t),t+=8,a=f?e.readDoubleLE(t):e.readDoubleBE(t),t+=8,s.push({x:n,y:a});break;case 3:var h=f?e.readUInt32LE(t):e.readUInt32BE(t);for(t+=4,s=[],u=h;u>0;u--){o=f?e.readUInt32LE(t):e.readUInt32BE(t),t+=4;for(var _=[],c=o;c>0;c--)n=f?e.readDoubleLE(t):e.readDoubleBE(t),t+=8,a=f?e.readDoubleLE(t):e.readDoubleBE(t),t+=8,_.push({x:n,y:a});s.push(_)}break;case 4:case 5:case 6:case 7:var p=f?e.readUInt32LE(t):e.readUInt32BE(t);for(t+=4,s=[],u=p;u>0;u--)s.push(r())}return s}():null},Parser.prototype.reachedPacketEnd=function(){return this._offset===this._packetEnd},Parser.prototype.incrementPacketNumber=function(){var e=this._nextPacketNumber;return this._nextPacketNumber=(this._nextPacketNumber+1)%256,e},Parser.prototype.resetPacketNumber=function(){this._nextPacketNumber=0},Parser.prototype.packetLength=function(){return this._packetHeader?this._packetHeader.length+this._longPacketBuffers.size:null},Parser.prototype._combineNextBuffers=function(e){var t=this._buffer.length-this._offset;if(t>=e)return!0;if(t+this._nextBuffers.size<e)return!1;for(var r=[],s=e-t;s>0;){var f=this._nextBuffers.shift();r.push(f),s-=f.length}return this.append(r),!0},Parser.prototype._combineLongPacketBuffers=function(){if(this._longPacketBuffers.size){for(var e=this._buffer.length-this._offset,t=this._buffer.length-this._packetEnd,r=null,s=Buffer.allocUnsafe(e+this._longPacketBuffers.size),f=0;r=this._longPacketBuffers.shift();)f+=r.copy(s,f);this._buffer.copy(s,f,this._offset),this._buffer=s,this._offset=0,this._packetEnd=this._buffer.length-t,this._packetOffset=0}},Parser.prototype._parsePacket=function(e){if(this._packetEnd=this._offset+e.length,this._packetOffset=this._offset,e.length===MAX_PACKET_LENGTH)return this._longPacketBuffers.push(this._buffer.slice(this._packetOffset,this._packetEnd)),void this._advanceToNextPacket();this._combineLongPacketBuffers();var t=!0;try{this._onPacket(e),t=!1}catch(e){if(!e||"string"!=typeof e.code||"PARSER_"!==e.code.substr(0,7))throw e;this._onError(e),t=!1}finally{this._advanceToNextPacket(),t&&process.nextTick(this.write.bind(this))}},Parser.prototype._tryReadPacketHeader=function(){if(this._packetHeader)return this._packetHeader;if(!this._combineNextBuffers(PACKET_HEADER_LENGTH))return null;if(this._packetHeader=new PacketHeader(this.parseUnsignedNumber(3),this.parseUnsignedNumber(1)),this._packetHeader.number!==this._nextPacketNumber){var e=new Error("Packets out of order. Got: "+this._packetHeader.number+" Expected: "+this._nextPacketNumber);e.code="PROTOCOL_PACKETS_OUT_OF_ORDER",e.fatal=!0,this._onError(e)}return this.incrementPacketNumber(),this._packetHeader},Parser.prototype._advanceToNextPacket=function(){this._offset=this._packetEnd,this._packetHeader=null,this._packetEnd=null,this._packetOffset=null};