var Util=require("util"),EventEmitter=require("events").EventEmitter,Packets=require("../packets"),ErrorConstants=require("../constants/errors"),Timer=require("../Timer"),listenerCount=EventEmitter.listenerCount||function(e,t){return e.listeners(t).length},LONG_STACK_DELIMITER="\n    --------------------\n";function Sequence(e,t){"function"==typeof e&&(t=e,e={}),EventEmitter.call(this),e=e||{},this._callback=t,this._callSite=null,this._ended=!1,this._timeout=e.timeout,this._timer=new Timer(this)}module.exports=Sequence,Util.inherits(Sequence,EventEmitter),Sequence.determinePacket=function(e){switch(e){case 0:return Packets.OkPacket;case 254:return Packets.EofPacket;case 255:return Packets.ErrorPacket;default:return}},Sequence.prototype.hasErrorHandler=function(){return Boolean(this._callback)||listenerCount(this,"error")>1},Sequence.prototype._packetToError=function(e){var t=ErrorConstants[e.errno]||"UNKNOWN_CODE_PLEASE_REPORT",r=new Error(t+": "+e.message);return r.code=t,r.errno=e.errno,r.sqlMessage=e.message,r.sqlState=e.sqlState,r},Sequence.prototype.end=function(e){if(!this._ended){this._ended=!0,e&&this._addLongStackTrace(e),this._callSite=null;try{e&&this.emit("error",e)}finally{try{this._callback&&this._callback.apply(this,arguments)}finally{this.emit("end")}}}},Sequence.prototype.OkPacket=function(e){this.end(null,e)},Sequence.prototype.ErrorPacket=function(e){this.end(this._packetToError(e))},Sequence.prototype.start=function(){},Sequence.prototype._addLongStackTrace=function(e){var t=this._callSite&&this._callSite.stack;if(t&&"string"==typeof t&&-1===e.stack.indexOf(LONG_STACK_DELIMITER)){var r=t.indexOf("\n");-1!==r&&(e.stack+=LONG_STACK_DELIMITER+t.substr(r+1))}},Sequence.prototype._onTimeout=function(){this.emit("timeout")};