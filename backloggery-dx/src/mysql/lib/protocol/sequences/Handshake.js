var Sequence=require("./Sequence"),Util=require("util"),Packets=require("../packets"),Auth=require("../Auth"),ClientConstants=require("../constants/client");function Handshake(e,t){Sequence.call(this,e,t),e=e||{},this._config=e.config,this._handshakeInitializationPacket=null}module.exports=Handshake,Util.inherits(Handshake,Sequence),Handshake.prototype.determinePacket=function(e,t){return 255===e?Packets.ErrorPacket:this._handshakeInitializationPacket?254===e?1===t.packetLength()?Packets.UseOldPasswordPacket:Packets.AuthSwitchRequestPacket:void 0:Packets.HandshakeInitializationPacket},Handshake.prototype.AuthSwitchRequestPacket=function(e){var t=e.authMethodName,a=Auth.auth(t,e.authMethodData,{password:this._config.password});if(void 0!==a)this.emit("packet",new Packets.AuthSwitchResponsePacket({data:a}));else{var i=new Error("MySQL is requesting the "+t+" authentication method, which is not supported.");i.code="UNSUPPORTED_AUTH_METHOD",i.fatal=!0,this.end(i)}},Handshake.prototype.HandshakeInitializationPacket=function(e){this._handshakeInitializationPacket=e,this._config.protocol41=e.protocol41;var t=e.serverCapabilities1&ClientConstants.CLIENT_SSL;if(this._config.ssl){if(!t){var a=new Error("Server does not support secure connection");return a.code="HANDSHAKE_NO_SSL_SUPPORT",a.fatal=!0,void this.end(a)}this._config.clientFlags|=ClientConstants.CLIENT_SSL,this.emit("packet",new Packets.SSLRequestPacket({clientFlags:this._config.clientFlags,maxPacketSize:this._config.maxPacketSize,charsetNumber:this._config.charsetNumber})),this.emit("start-tls")}else this._sendCredentials()},Handshake.prototype._tlsUpgradeCompleteHandler=function(){this._sendCredentials()},Handshake.prototype._sendCredentials=function(){var e=this._handshakeInitializationPacket;this.emit("packet",new Packets.ClientAuthenticationPacket({clientFlags:this._config.clientFlags,maxPacketSize:this._config.maxPacketSize,charsetNumber:this._config.charsetNumber,user:this._config.user,database:this._config.database,protocol41:e.protocol41,scrambleBuff:e.protocol41?Auth.token(this._config.password,e.scrambleBuff()):Auth.scramble323(e.scrambleBuff(),this._config.password)}))},Handshake.prototype.UseOldPasswordPacket=function(){if(!this._config.insecureAuth){var e=new Error("MySQL server is requesting the old and insecure pre-4.1 auth mechanism. Upgrade the user password or use the {insecureAuth: true} option.");return e.code="HANDSHAKE_INSECURE_AUTH",e.fatal=!0,void this.end(e)}this.emit("packet",new Packets.OldPasswordPacket({scrambleBuff:Auth.scramble323(this._handshakeInitializationPacket.scrambleBuff(),this._config.password)}))},Handshake.prototype.ErrorPacket=function(e){var t=this._packetToError(e,!0);t.fatal=!0,this.end(t)};