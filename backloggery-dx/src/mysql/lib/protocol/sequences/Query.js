var ClientConstants=require("../constants/client"),fs=require("fs"),Packets=require("../packets"),ResultSet=require("../ResultSet"),Sequence=require("./Sequence"),ServerStatus=require("../constants/server_status"),Readable=require("readable-stream"),Util=require("util");function Query(e,t){Sequence.call(this,e,t),this.sql=e.sql,this.values=e.values,this.typeCast=void 0===e.typeCast||e.typeCast,this.nestTables=e.nestTables||!1,this._resultSet=null,this._results=[],this._fields=[],this._index=0,this._loadError=null}module.exports=Query,Util.inherits(Query,Sequence),Query.prototype.start=function(){this.emit("packet",new Packets.ComQueryPacket(this.sql))},Query.prototype.determinePacket=function(e,t){var s=this._resultSet;if(!s)switch(e){case 0:return Packets.OkPacket;case 251:return Packets.LocalInfileRequestPacket;case 255:return Packets.ErrorPacket;default:return Packets.ResultSetHeaderPacket}return 0===s.eofPackets.length?s.fieldPackets.length<s.resultSetHeaderPacket.fieldCount?Packets.FieldPacket:Packets.EofPacket:255===e?Packets.ErrorPacket:254===e&&t.packetLength()<9?Packets.EofPacket:Packets.RowDataPacket},Query.prototype.OkPacket=function(e){try{this._callback?(this._results.push(e),this._fields.push(void 0)):this.emit("result",e,this._index)}finally{this._index++,this._resultSet=null,this._handleFinalResultPacket(e)}},Query.prototype.ErrorPacket=function(e){var t=this._packetToError(e),s=this._results.length>0?this._results:void 0,i=this._fields.length>0?this._fields:void 0;t.index=this._index,t.sql=this.sql,this.end(t,s,i)},Query.prototype.LocalInfileRequestPacket=function(e){this._connection.config.clientFlags&ClientConstants.CLIENT_LOCAL_FILES?this._sendLocalDataFile(e.filename):(this._loadError=new Error("Load local files command is disabled"),this._loadError.code="LOCAL_FILES_DISABLED",this._loadError.fatal=!1,this.emit("packet",new Packets.EmptyPacket))},Query.prototype.ResultSetHeaderPacket=function(e){this._resultSet=new ResultSet(e)},Query.prototype.FieldPacket=function(e){this._resultSet.fieldPackets.push(e)},Query.prototype.EofPacket=function(e){this._resultSet.eofPackets.push(e),1!==this._resultSet.eofPackets.length||this._callback||this.emit("fields",this._resultSet.fieldPackets,this._index),2===this._resultSet.eofPackets.length&&(this._callback&&(this._results.push(this._resultSet.rows),this._fields.push(this._resultSet.fieldPackets)),this._index++,this._resultSet=null,this._handleFinalResultPacket(e))},Query.prototype._handleFinalResultPacket=function(e){if(!(e.serverStatus&ServerStatus.SERVER_MORE_RESULTS_EXISTS)){var t=this._results.length>1?this._results:this._results[0],s=this._fields.length>1?this._fields:this._fields[0];this.end(this._loadError,t,s)}},Query.prototype.RowDataPacket=function(e,t,s){e.parse(t,this._resultSet.fieldPackets,this.typeCast,this.nestTables,s),this._callback?this._resultSet.rows.push(e):this.emit("result",e,this._index)},Query.prototype._sendLocalDataFile=function(e){var t=this,s=fs.createReadStream(e,{flag:"r",encoding:null,autoClose:!0});this.on("pause",(function(){s.pause()})),this.on("resume",(function(){s.resume()})),s.on("data",(function(e){t.emit("packet",new Packets.LocalDataFilePacket(e))})),s.on("error",(function(e){t._loadError=e,s.emit("end")})),s.on("end",(function(){t.emit("packet",new Packets.EmptyPacket)}))},Query.prototype.stream=function(e){var t=this;(e=e||{}).objectMode=!0;var s=new Readable(e);return s._read=function(){t._connection&&t._connection.resume()},s.once("end",(function(){process.nextTick((function(){s.emit("close")}))})),this.on("result",(function(e,i){s.push(e)||t._connection.pause(),s.emit("result",e,i)})),this.on("error",(function(e){s.emit("error",e)})),this.on("end",(function(){s.push(null)})),this.on("fields",(function(e,t){s.emit("fields",e,t)})),s};