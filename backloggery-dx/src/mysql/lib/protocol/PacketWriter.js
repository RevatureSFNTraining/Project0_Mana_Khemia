var BIT_16=Math.pow(2,16),BIT_24=Math.pow(2,24),BUFFER_ALLOC_SIZE=Math.pow(2,8),IEEE_754_BINARY_64_PRECISION=Math.pow(2,53),MAX_PACKET_LENGTH=Math.pow(2,24)-1,Buffer=require("safe-buffer").Buffer;function PacketWriter(){this._buffer=null,this._offset=0}module.exports=PacketWriter,PacketWriter.prototype.toBuffer=function(t){this._buffer||(this._buffer=Buffer.alloc(0),this._offset=0);var e=this._buffer,f=this._offset,r=Math.floor(f/MAX_PACKET_LENGTH)+1;this._buffer=Buffer.allocUnsafe(f+4*r),this._offset=0;for(var i=0;i<r;i++){var s=i+1===r?f%MAX_PACKET_LENGTH:MAX_PACKET_LENGTH,o=t.incrementPacketNumber();this.writeUnsignedNumber(3,s),this.writeUnsignedNumber(1,o);var h=i*MAX_PACKET_LENGTH,_=h+s;this.writeBuffer(e.slice(h,_))}return this._buffer},PacketWriter.prototype.writeUnsignedNumber=function(t,e){this._allocate(t);for(var f=0;f<t;f++)this._buffer[this._offset++]=e>>8*f&255},PacketWriter.prototype.writeFiller=function(t){this._allocate(t);for(var e=0;e<t;e++)this._buffer[this._offset++]=0},PacketWriter.prototype.writeNullTerminatedString=function(t,e){t=t||"",t+="";var f=Buffer.byteLength(t,e||"utf-8")+1;this._allocate(f),this._buffer.write(t,this._offset,e),this._buffer[this._offset+f-1]=0,this._offset+=f},PacketWriter.prototype.writeString=function(t){t=t||"",t+="";var e=Buffer.byteLength(t,"utf-8");this._allocate(e),this._buffer.write(t,this._offset,"utf-8"),this._offset+=e},PacketWriter.prototype.writeBuffer=function(t){var e=t.length;this._allocate(e),t.copy(this._buffer,this._offset),this._offset+=e},PacketWriter.prototype.writeLengthCodedNumber=function(t){if(null===t)return this._allocate(1),void(this._buffer[this._offset++]=251);if(t<=250)return this._allocate(1),void(this._buffer[this._offset++]=t);if(t>IEEE_754_BINARY_64_PRECISION)throw new Error('writeLengthCodedNumber: JS precision range exceeded, your number is > 53 bit: "'+t+'"');t<BIT_16?(this._allocate(3),this._buffer[this._offset++]=252):t<BIT_24?(this._allocate(4),this._buffer[this._offset++]=253):(this._allocate(9),this._buffer[this._offset++]=254),this._buffer[this._offset++]=255&t,this._buffer[this._offset++]=t>>8&255,t<BIT_16||(this._buffer[this._offset++]=t>>16&255,t<BIT_24||(this._buffer[this._offset++]=t>>24&255,t=(t=t.toString(2)).substr(0,t.length-32),t=parseInt(t,2),this._buffer[this._offset++]=255&t,this._buffer[this._offset++]=t>>8&255,this._buffer[this._offset++]=t>>16&255,this._buffer[this._offset++]=0))},PacketWriter.prototype.writeLengthCodedBuffer=function(t){var e=t.length;this.writeLengthCodedNumber(e),this.writeBuffer(t)},PacketWriter.prototype.writeNullTerminatedBuffer=function(t){this.writeBuffer(t),this.writeFiller(1)},PacketWriter.prototype.writeLengthCodedString=function(t){if(null!==t){t=void 0===t?"":String(t);var e=Buffer.byteLength(t,"utf-8");this.writeLengthCodedNumber(e),e&&(this._allocate(e),this._buffer.write(t,this._offset,"utf-8"),this._offset+=e)}else this.writeLengthCodedNumber(null)},PacketWriter.prototype._allocate=function(t){if(!this._buffer)return this._buffer=Buffer.alloc(Math.max(BUFFER_ALLOC_SIZE,t)),void(this._offset=0);if(!(this._buffer.length-this._offset>=t)){var e=this._buffer.length+Math.max(BUFFER_ALLOC_SIZE,t),f=this._buffer;this._buffer=Buffer.alloc(e),f.copy(this._buffer)}};