var Pool=require("./Pool"),PoolConfig=require("./PoolConfig"),PoolNamespace=require("./PoolNamespace"),PoolSelector=require("./PoolSelector"),Util=require("util"),EventEmitter=require("events").EventEmitter;function PoolCluster(e){EventEmitter.call(this),e=e||{},this._canRetry=void 0===e.canRetry||e.canRetry,this._defaultSelector=e.defaultSelector||"RR",this._removeNodeErrorCount=e.removeNodeErrorCount||5,this._restoreNodeTimeout=e.restoreNodeTimeout||0,this._closed=!1,this._findCaches=Object.create(null),this._lastId=0,this._namespaces=Object.create(null),this._nodes=Object.create(null)}function getMonotonicMilliseconds(){var e;return e="function"==typeof process.hrtime?1e3*(e=process.hrtime())[0]+1e-6*e[1]:1e3*process.uptime(),Math.floor(e)}function isRegExp(e){return"object"==typeof e&&"[object RegExp]"===Object.prototype.toString.call(e)}function patternRegExp(e){if(isRegExp(e))return e;var o=e.replace(/([.+?^=!:${}()|\[\]\/\\])/g,"\\$1").replace(/\*/g,".*");return new RegExp("^"+o+"$")}function _cb(e){if(e)throw e}function _noop(){}module.exports=PoolCluster,Util.inherits(PoolCluster,EventEmitter),PoolCluster.prototype.add=function(e,o){if(this._closed)throw new Error("PoolCluster is closed.");var t="object"==typeof e?"CLUSTER::"+ ++this._lastId:String(e);if(void 0!==this._nodes[t])throw new Error('Node ID "'+t+'" is already defined in PoolCluster.');var r=new PoolConfig("object"!=typeof e?o:e);this._nodes[t]={id:t,errorCount:0,pool:new Pool({config:r}),_offlineUntil:0},this._clearFindCaches()},PoolCluster.prototype.end=function(e){var o=void 0!==e?e:_cb;if("function"!=typeof o)throw TypeError("callback argument must be a function");if(this._closed)process.nextTick(o);else{this._closed=!0;for(var t=!1,r=Object.keys(this._nodes),i=0,n=0;n<r.length;n++){var s=r[n],l=this._nodes[s];i++,l.pool.end(c)}0===i&&process.nextTick(c)}function c(e){!t&&(e||--i<=0)&&(t=!0,o(e))}},PoolCluster.prototype.of=function(e,o){e=e||"*",o=(o=o||this._defaultSelector).toUpperCase(),void 0===PoolSelector[o]&&(o=this._defaultSelector);var t=e+o;return void 0===this._namespaces[t]&&(this._namespaces[t]=new PoolNamespace(this,e,o)),this._namespaces[t]},PoolCluster.prototype.remove=function(e){for(var o=this._findNodeIds(e,!0),t=0;t<o.length;t++){var r=this._getNode(o[t]);r&&this._removeNode(r)}},PoolCluster.prototype.getConnection=function(e,o,t){var r;"function"==typeof e?(t=e,r=this.of()):("function"==typeof o&&(t=o,o=this._defaultSelector),r=this.of(e,o)),r.getConnection(t)},PoolCluster.prototype._clearFindCaches=function(){this._findCaches=Object.create(null)},PoolCluster.prototype._decreaseErrorCount=function(e){var o=e.errorCount;o>this._removeNodeErrorCount&&(o=this._removeNodeErrorCount),o<1&&(o=1),e.errorCount=o-1,e._offlineUntil&&(e._offlineUntil=0,this.emit("online",e.id))},PoolCluster.prototype._findNodeIds=function(e,o){var t=0,r=this._findCaches[e];if(void 0===r){var i=patternRegExp(e);r=Object.keys(this._nodes).filter((function(e){return e.match(i)})),this._findCaches[e]=r}return o?r:r.filter((function(e){var o=this._getNode(e);return!o._offlineUntil||(t||(t=getMonotonicMilliseconds()),o._offlineUntil<=t)}),this)},PoolCluster.prototype._getNode=function(e){return this._nodes[e]||null},PoolCluster.prototype._increaseErrorCount=function(e){var o=++e.errorCount;if(!(this._removeNodeErrorCount>o)){if(this._restoreNodeTimeout>0)return e._offlineUntil=getMonotonicMilliseconds()+this._restoreNodeTimeout,void this.emit("offline",e.id);this._removeNode(e),this.emit("remove",e.id)}},PoolCluster.prototype._getConnection=function(e,o){var t=this;e.pool.getConnection((function(r,i){if(r)return t._increaseErrorCount(e),void o(r);t._decreaseErrorCount(e),i._clusterId=e.id,o(null,i)}))},PoolCluster.prototype._removeNode=function(e){delete this._nodes[e.id],this._clearFindCaches(),e.pool.end(_noop)};