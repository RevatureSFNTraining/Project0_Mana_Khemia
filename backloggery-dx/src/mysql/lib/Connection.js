var Crypto=require("crypto"),Events=require("events"),Net=require("net"),tls=require("tls"),ConnectionConfig=require("./ConnectionConfig"),Protocol=require("./protocol/Protocol"),SqlString=require("./protocol/SqlString"),Query=require("./protocol/sequences/Query"),Util=require("util");function Connection(t){Events.EventEmitter.call(this),this.config=t.config,this._socket=t.socket,this._protocol=new Protocol({config:this.config,connection:this}),this._connectCalled=!1,this.state="disconnected",this.threadId=null}function createSecureContext(t,o){var n=null,e=null;try{n=tls.createSecureContext({ca:t.ssl.ca,cert:t.ssl.cert,ciphers:t.ssl.ciphers,key:t.ssl.key,passphrase:t.ssl.passphrase})}catch(t){e=t}o(e,n)}function unwrapFromDomain(t){return function(){for(var o,n=[];process.domain;)n.shift(process.domain),process.domain.exit();try{o=t.apply(this,arguments)}finally{for(var e=0;e<n.length;e++)n[e].enter()}return o}}function wrapCallbackInDomain(t,o){if("function"==typeof o){if(o.domain)return o;var n=process.domain;return n?n.bind(o):t?unwrapFromDomain(wrapToDomain(t,o)):o}}function wrapToDomain(t,o){return function(){Events.usingDomains&&t.domain?(t.domain.enter(),o.apply(this,arguments),t.domain.exit()):o.apply(this,arguments)}}module.exports=Connection,Util.inherits(Connection,Events.EventEmitter),Connection.createQuery=function(t,o,n){if(t instanceof Query)return t;var e=n,i={};if("function"==typeof t?e=t:"object"==typeof t?(i=Object.create(t),"function"==typeof o?e=o:void 0!==o&&Object.defineProperty(i,"values",{value:o})):(i.sql=t,"function"==typeof o?e=o:void 0!==o&&(i.values=o)),void 0!==e&&void 0===(e=wrapCallbackInDomain(null,e)))throw new TypeError("argument callback must be a function when provided");return new Query(i,e)},Connection.prototype.connect=function(t,o){if(o||"function"!=typeof t||(o=t,t={}),!this._connectCalled){this._connectCalled=!0,this._socket=this.config.socketPath?Net.createConnection(this.config.socketPath):Net.createConnection(this.config.port,this.config.host),Events.usingDomains&&(this._socket.domain=this.domain);var n=this;if(this._protocol.on("data",(function(t){n._socket.write(t)})),this._socket.on("data",wrapToDomain(n,(function(t){n._protocol.write(t)}))),this._protocol.on("end",(function(){n._socket.end()})),this._socket.on("end",wrapToDomain(n,(function(){n._protocol.end()}))),this._socket.on("error",this._handleNetworkError.bind(this)),this._socket.on("connect",this._handleProtocolConnect.bind(this)),this._protocol.on("handshake",this._handleProtocolHandshake.bind(this)),this._protocol.on("initialize",this._handleProtocolInitialize.bind(this)),this._protocol.on("unhandledError",this._handleProtocolError.bind(this)),this._protocol.on("drain",this._handleProtocolDrain.bind(this)),this._protocol.on("end",this._handleProtocolEnd.bind(this)),this._protocol.on("enqueue",this._handleProtocolEnqueue.bind(this)),this.config.connectTimeout){var e=this._handleConnectTimeout.bind(this);this._socket.setTimeout(this.config.connectTimeout,e),this._socket.once("connect",(function(){this.setTimeout(0,e)}))}}this._protocol.handshake(t,wrapCallbackInDomain(this,o))},Connection.prototype.changeUser=function(t,o){o||"function"!=typeof t||(o=t,t={}),this._implyConnect();var n=t.charset?ConnectionConfig.getCharsetNumber(t.charset):this.config.charsetNumber;return this._protocol.changeUser({user:t.user||this.config.user,password:t.password||this.config.password,database:t.database||this.config.database,timeout:t.timeout,charsetNumber:n,currentConfig:this.config},wrapCallbackInDomain(this,o))},Connection.prototype.beginTransaction=function(t,o){return o||"function"!=typeof t||(o=t,t={}),(t=t||{}).sql="START TRANSACTION",t.values=null,this.query(t,o)},Connection.prototype.commit=function(t,o){return o||"function"!=typeof t||(o=t,t={}),(t=t||{}).sql="COMMIT",t.values=null,this.query(t,o)},Connection.prototype.rollback=function(t,o){return o||"function"!=typeof t||(o=t,t={}),(t=t||{}).sql="ROLLBACK",t.values=null,this.query(t,o)},Connection.prototype.query=function(t,o,n){var e=Connection.createQuery(t,o,n);return e._connection=this,"object"==typeof t&&"typeCast"in t||(e.typeCast=this.config.typeCast),e.sql&&(e.sql=this.format(e.sql,e.values)),e._callback&&(e._callback=wrapCallbackInDomain(this,e._callback)),this._implyConnect(),this._protocol._enqueue(e)},Connection.prototype.ping=function(t,o){o||"function"!=typeof t||(o=t,t={}),this._implyConnect(),this._protocol.ping(t,wrapCallbackInDomain(this,o))},Connection.prototype.statistics=function(t,o){o||"function"!=typeof t||(o=t,t={}),this._implyConnect(),this._protocol.stats(t,wrapCallbackInDomain(this,o))},Connection.prototype.end=function(t,o){var n=o,e=t;o||"function"!=typeof t||(n=t,e=null),void 0===(e=Object.create(e||null)).timeout&&(e.timeout=3e4),this._implyConnect(),this._protocol.quit(e,wrapCallbackInDomain(this,n))},Connection.prototype.destroy=function(){this.state="disconnected",this._implyConnect(),this._socket.destroy(),this._protocol.destroy()},Connection.prototype.pause=function(){this._socket.pause(),this._protocol.pause()},Connection.prototype.resume=function(){this._socket.resume(),this._protocol.resume()},Connection.prototype.escape=function(t){return SqlString.escape(t,!1,this.config.timezone)},Connection.prototype.escapeId=function(t){return SqlString.escapeId(t,!1)},Connection.prototype.format=function(t,o){return"function"==typeof this.config.queryFormat?this.config.queryFormat.call(this,t,o,this.config.timezone):SqlString.format(t,o,this.config.stringifyObjects,this.config.timezone)},tls.TLSSocket?Connection.prototype._startTLS=function(t){var o=this;createSecureContext(this.config,(function(n,e){if(n)t(n);else{o._socket.removeAllListeners("data"),o._protocol.removeAllListeners("data");var i=o.config.ssl.rejectUnauthorized,r=!1,c=new tls.TLSSocket(o._socket,{rejectUnauthorized:i,requestCert:!0,secureContext:e,isServer:!1});c.on("_tlsError",(function(n){r?o._handleNetworkError(n):t(n)})),c.pipe(o._protocol),o._protocol.on("data",(function(t){c.write(t)})),c.on("secure",(function(){r=!0,t(i?this.ssl.verifyError():null)})),c._start()}}))}:Connection.prototype._startTLS=function(t){var o=this,n=Crypto.createCredentials({ca:this.config.ssl.ca,cert:this.config.ssl.cert,ciphers:this.config.ssl.ciphers,key:this.config.ssl.key,passphrase:this.config.ssl.passphrase}),e=this.config.ssl.rejectUnauthorized,i=!1,r=tls.createSecurePair(n,!1,!0,e);r.on("error",(function(n){i?o._handleNetworkError(n):t(n)})),this._socket.removeAllListeners("data"),this._protocol.removeAllListeners("data"),r.encrypted.pipe(this._socket),this._socket.on("data",(function(t){r.encrypted.write(t)})),r.cleartext.pipe(this._protocol),this._protocol.on("data",(function(t){r.cleartext.write(t)})),r.on("secure",(function(){if(i=!0,e){var o=this.ssl.verifyError(),n=o;"string"==typeof n&&((n=new Error(o)).code=o),t(n)}else t()})),r._cycle=r.cycle,r.cycle=function(){return this.ssl&&this.ssl.error&&this.error(),this._cycle.apply(this,arguments)}},Connection.prototype._handleConnectTimeout=function(){this._socket&&(this._socket.setTimeout(0),this._socket.destroy());var t=new Error("connect ETIMEDOUT");t.errorno="ETIMEDOUT",t.code="ETIMEDOUT",t.syscall="connect",this._handleNetworkError(t)},Connection.prototype._handleNetworkError=function(t){this._protocol.handleNetworkError(t)},Connection.prototype._handleProtocolError=function(t){this.state="protocol_error",this.emit("error",t)},Connection.prototype._handleProtocolDrain=function(){this.emit("drain")},Connection.prototype._handleProtocolConnect=function(){this.state="connected",this.emit("connect")},Connection.prototype._handleProtocolHandshake=function(){this.state="authenticated"},Connection.prototype._handleProtocolInitialize=function(t){this.threadId=t.threadId},Connection.prototype._handleProtocolEnd=function(t){this.state="disconnected",this.emit("end",t)},Connection.prototype._handleProtocolEnqueue=function(t){this.emit("enqueue",t)},Connection.prototype._implyConnect=function(){this._connectCalled||this.connect()};