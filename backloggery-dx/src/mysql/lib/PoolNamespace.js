var Connection=require("./Connection"),PoolSelector=require("./PoolSelector");function PoolNamespace(e,o,t){this._cluster=e,this._pattern=o,this._selector=new PoolSelector[t]}module.exports=PoolNamespace,PoolNamespace.prototype.getConnection=function(e){var o=this._getClusterNode(),t=this._cluster,n=this;if(null===o){var r=null;return 0!==this._cluster._findNodeIds(this._pattern,!0).length?(r=new Error("Pool does not have online node.")).code="POOL_NONEONLINE":(r=new Error("Pool does not exist.")).code="POOL_NOEXIST",void e(r)}t._getConnection(o,(function(o,r){o&&t._canRetry&&0!==t._findNodeIds(n._pattern).length?n.getConnection(e):o?e(o):e(null,r)}))},PoolNamespace.prototype.query=function(e,o,t){var n=this._cluster,r=this._getClusterNode(),i=Connection.createQuery(e,o,t),l=this;if(null===r){var c=null;return 0!==this._cluster._findNodeIds(this._pattern,!0).length?(c=new Error("Pool does not have online node.")).code="POOL_NONEONLINE":(c=new Error("Pool does not exist.")).code="POOL_NOEXIST",process.nextTick((function(){i.on("error",(function(){})),i.end(c)})),i}return"object"==typeof e&&"typeCast"in e||(i.typeCast=r.pool.config.connectionConfig.typeCast),r.pool.config.connectionConfig.trace&&(i._callSite=new Error),n._getConnection(r,(function(e,o){if(e&&n._canRetry&&0!==n._findNodeIds(l._pattern).length)l.query(i);else{if(e)return i.on("error",(function(){})),void i.end(e);i.once("end",(function(){o.release()})),o.query(i)}})),i},PoolNamespace.prototype._getClusterNode=function(){var e,o=this._cluster._findNodeIds(this._pattern);switch(o.length){case 0:e=null;break;case 1:e=o[0];break;default:e=this._selector(o)}return null!==e?this._cluster._getNode(e):null};